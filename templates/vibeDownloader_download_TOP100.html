{% extends "base.html" %}
{% block content %}
<style type="text/css">
  .img_thumb { 
    width: 40px;
    height: 40px;
  }
</style>
<div>
  <div class="audioPlay" hidden>
    <video id="video"></video>
  </div>
  <div class="modalinner">
    <div class="modalinnerbyAlbum"></div>
    <div class="modalinnerbyArtist"></div>  
  </div>
  <div id="list_title"></div>
  {{ macros.m_hr_head_top() }}
  {{ macros.m_row_start('0') }}
  {{ macros.m_row_end() }}
  <div id="list_div"></div>
  <div id='page2'></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script src="{{ url_for('.static', filename='modal.js') }}?v={{arg['v'] }}"></script>
<script type="text/javascript">
var package_name = "{{arg['package_name'] }}";
var sub = "{{arg['sub'] }}";
var current_data = null;
var current_page = 1;
var formData = null;

$(document).ready(function(){

  request_search();
  
});

$("body").on('click', '#page', function(e){
  e.preventDefault();
  var page = $(this).data('page')
  request_search(page, true);
});

$("#search").click(function(e) {
  e.preventDefault();
  request_search('1', true);
});

$("#reset_btn").click(function(e) {
  e.preventDefault();
  document.getElementById("search_word").value = '';
  request_search(current_page, true);
});

function request_search() {
  
  $.ajax({
    url: '/' + package_name + '/ajax/'+sub+'/top100',
    type: "POST", 
    cache: false,
    data: null,
    dataType: "json",
    success: function (data) {
      if (scroll == true) {
        window.scrollTo(0,0);
      }
      if( data.ret == "success" ){
        make_list(data.content.response.result.chart)
        downloadEventAdd("TOP100");
      }
    }
  });
}

// 페이지 구성 함수
function make_list(chart) {

  
  str = "";
  
  for( i = 0 ; i < chart.items.trackTotalCount ; i++ ){
    track = chart.items.tracks.track[i];
    
    str += m_row_start();
    // tmp = '<center><input type="checkbox" id="chk_track_49356016" class="input_check"></center>';
    // str += m_col(1, tmp)
    tmp = track.rank.currentRank;

    if( track.rank.rankVariation != 0 ){
      arrow = "";
      color = "";
      if ( track.rank.rankVariation > 0 ){
        arrow = "▲";
        color = "red";
      }else if ( track.rank.rankVariation < 0 ){
        arrow = "▼";
        color = "blue";
      }
      tmp += ' <span style="color: '+color+'; font-weight: bold;"> '+Math.abs(track.rank.rankVariation)+ arrow + '</span>';
    }
    
    str += m_col(1, tmp);
    
    tmp = '<img src="'+track.album.imageUrl+'" alt="'+track.album.albumTitle+'" class="img_thumb">';
    str += m_col(1, tmp);

    tmp = track.trackTitle;
    str += m_col(3, tmp);

    tmp = "";
    if( track.artists.artist[0] == undefined ){
      artistName = track.artists.artist.artistName;
      artistId = track.artists.artist.artistId;
      tmp = '<a href="#" alt = "'+artistId+'" class="alert-link text-dark artistView">'+ artistName + '</a>';
    }else{
      for( var j in track.artists.artist){
        if( j > 0 ){
          tmp += ", ";
        }
        artistName = track.artists.artist[j].artistName;
        artistId = track.artists.artist[j].artistId;
        tmp += '<a href="#" alt = "'+artistId+'" class="alert-link text-dark artistView">'+ artistName + '</a>';
      }
    }

    
    str += m_col(3, tmp);
    tmp = '<a href="#" alt = "'+track.album.albumId+'" class="alert-link text-dark albumView">'+ track.album.albumTitle + '</a>';
    str += m_col(2, tmp);
    btn_str = m_button('btn_download', '다운로드', [{'key':'trackid', 'value':track.trackId}]);
    btn_str += m_button('btn_play', '재생', [{'key':'trackid', 'value':track.trackId}]);
    tmp = m_button_group(btn_str);
    str += m_col(2, tmp, "right");
    str += m_row_end();
  }
  
  document.getElementById("list_div").innerHTML = str;

  btn_str = m_button('btn_download_all', '전체다운로드', [{'key':'trackid', 'value':''}]);
  tmp = m_button_group(btn_str);

  title = m_row_start();
  title = '<div class="container">';
  title += '  <div class="row justify-content-between">';
  title += '    <div class="col-8">';
  title += '      '+chart.chartDate + '<br>' + chart.description;
  title += '    </div>';
  title += '    <div class="col-4 text-right">';
  title += '      ' + tmp;
  title += '    </div>';
  title += '  </div>';
  title += '</div>';
  // tmp = ;
  // title += m_col(3, tmp)
  
  // title += m_col(1, tmp);
  // title += m_row_end();
  document.getElementById("list_title").innerHTML = title;
  
}

$("body").on('click', '.albumView', function(e){
  e.preventDefault();
  albumModalView($(this).attr("alt"));
});
$("body").on('click', '.artistView', function(e){
  e.preventDefault();
  artistModalView($(this).attr("alt"));
});

</script>    
{% endblock %}
